<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Záznam Dat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .card {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-field,
        .select-field {
            background-color: #4a5568;
            color: #e2e8f0;
            border: 1px solid #718096;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }

        .input-field[readonly] {
            background-color: #2a3343;
            cursor: default;
        }

        .input-field:focus,
        .select-field:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.5);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            border: none;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #4299e1;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #3182ce;
        }

        .btn-secondary {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #718096;
        }

        .btn-danger {
            background-color: #e53e3e;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #c53030;
        }

        .json-output {
            background-color: #111827;
            color: #9ca3af;
            border: 1px solid #4a5568;
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #a0aec0;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 0.5rem;
        }

        .stats-category-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #a0aec0;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .player-dead .player-equipment {
            display: none;
        }

        .player-dead {
            opacity: 0.5;
        }

        .color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 2.5rem;
            height: 2.5rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
        }

        .color-picker::-webkit-color-swatch {
            border-radius: 0.375rem;
            border: 1px solid #718096;
        }

        .color-picker::-moz-color-swatch {
            border-radius: 0.375rem;
            border: 1px solid #718096;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-label span {
            font-size: 0.875rem;
            color: #a0aec0;
            white-space: nowrap;
        }
    </style>
</head>

<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">CS2 Záznam Dat</h1>
            <p class="text-lg text-gray-400 mt-2">Nástroj pro rekurzivní záznam herních statistik.</p>
        </header>

        <div class="card">
            <label for="demoName" class="block mb-2 font-semibold">Název CS2 hry (dema)</label>
            <input type="text" id="demoName" name="demoName" class="input-field" placeholder="Např. Faceit_Mirage_16-12"
                required>
        </div>

        <!-- Nastavení Hráčů -->
        <div id="player-setup" class="card">
            <h2 class="section-title">Výchozí nastavení hráčů</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <h3 class="font-bold text-cyan-400 mb-2">CT Hráči</h3>
                    <div id="ct-player-names" class="space-y-2" data-team="ct">
                        <!-- Player inputs will be generated by JS -->
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-orange-400 mb-2">T Hráči</h3>
                    <div id="t-player-names" class="space-y-2" data-team="t">
                        <!-- Player inputs will be generated by JS -->
                    </div>
                </div>
            </div>
            <button type="button" id="swap-teams-btn" class="btn btn-secondary w-full">Prohodit týmy</button>
        </div>

        <!-- Hlavní formulář -->
        <form id="game-form" class="space-y-6">
            <div id="rounds-container">
                <!-- Kolo bude přidáno dynamicky zde -->
            </div>
            <button type="button" id="add-round-btn" class="btn btn-secondary w-full">Přidat Kolo</button>
        </form>

        <!-- Ovládací tlačítka a výstup -->
        <div class="card mt-8">
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="button" id="generate-json-btn" class="btn btn-primary flex-1">Generovat JSON</button>
                <button type="button" id="copy-json-btn" class="btn btn-secondary flex-1">Kopírovat do schránky</button>
            </div>
            <div id="message-box" class="mt-4 text-center font-medium"></div>
            <pre id="json-output" class="json-output mt-4 hidden"></pre>
        </div>
    </div>

    <!-- Šablony pro dynamické prvky -->
    <template id="player-setup-template">
        <div class="flex items-center gap-2">
            <input type="text" class="input-field player-name-input" placeholder="Jméno hráče" value="" data-index="">
            <input type="color" class="color-picker player-color-input" value="#4A5568" data-index="">
        </div>
    </template>

    <template id="round-template">
        <div class="card round-card relative" data-round-id="">
            <button type="button" class="btn btn-danger btn-sm absolute top-4 right-4 remove-round-btn">X</button>
            <h2 class="section-title">Kolo č. <span class="round-number-display">1</span></h2>
            <input type="number" name="roundNumber" class="input-field mb-4" placeholder="Číslo kola" value="1" min="1"
                required>

            <div class="space-y-6">
                <div class="snapshot-container border border-gray-600 rounded-lg p-4" data-snapshot-name="at_1_tick">
                    <h3 class="font-semibold text-lg mb-4 text-gray-300">Snapshot: V 1. ticku</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card team-card" data-team-type="CT"></div>
                        <div class="card team-card" data-team-type="T"></div>
                    </div>
                </div>
                <div class="snapshot-container border border-gray-600 rounded-lg p-4"
                    data-snapshot-name="at_20_seconds">
                    <h3 class="font-semibold text-lg mb-4 text-gray-300">Snapshot: Po 20 sekundách</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card team-card" data-team-type="CT"></div>
                        <div class="card team-card" data-team-type="T"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="team-template">
        <h3 class="text-xl font-bold mb-4">Tým: <span class="team-name-display"></span></h3>
        <div class="team-stats mb-6">
            <h4 class="stats-category-title">Ekonomika</h4>
            <label class="stat-label"><span>Hodnota vybavení</span><input type="number" class="input-field"
                    name="equipmentValue" min="0" value="0" readonly></label>

            <h4 class="stats-category-title">Počet zbraní</h4>
            <div class="grid grid-cols-2 gap-2">
                <label class="stat-label"><span>AWP</span><input type="number" class="input-field" name="awpCount"
                        min="0" value="0" readonly></label>
                <label class="stat-label"><span>Pušky</span><input type="number" class="input-field" name="rifleCount"
                        min="0" value="0" readonly></label>
                <label class="stat-label"><span>SMG</span><input type="number" class="input-field" name="smgCount"
                        min="0" value="0" readonly></label>
                <label class="stat-label"><span>Pistole</span><input type="number" class="input-field"
                        name="pistolCount" min="0" value="0" readonly></label>
                <label class="stat-label col-span-2"><span>Non-default pistole</span><input type="number"
                        class="input-field" name="nonDefaultPistolCount" min="0" value="0" readonly></label>
            </div>

            <h4 class="stats-category-title">Vybavení a utility</h4>
            <div class="grid grid-cols-2 gap-2">
                <label class="stat-label"><span>Defuse kity</span><input type="number" class="input-field"
                        name="defuserCount" min="0" value="0" readonly></label>
                <label class="stat-label"><span>Utility celkem</span><input type="number" class="input-field"
                        name="utilityTotalCount" min="0" value="0" readonly></label>
                <label class="stat-label"><span>Smoke</span><input type="number" class="input-field" name="smokeCount"
                        min="0" value="0" readonly></label>
                <label class="stat-label"><span>HE</span><input type="number" class="input-field" name="heGrenadeCount"
                        min="0" value="0" readonly></label>
                <label class="stat-label"><span>Flash</span><input type="number" class="input-field"
                        name="flashbangCount" min="0" value="0" readonly></label>
                <label class="stat-label"><span>Molotov</span><input type="number" class="input-field"
                        name="molotovCount" min="0" value="0" readonly></label>
                <label class="stat-label"><span>Incendiary</span><input type="number" class="input-field"
                        name="incendiaryCount" min="0" value="0" readonly></label>
            </div>
        </div>
        <div class="players-container"></div>
    </template>

    <template id="player-template">
        <div class="player-card border-t border-gray-600 pt-4 mt-4 rounded-md p-2 transition-colors duration-300">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <p class="font-semibold player-name-display"></p>
                    <button type="button" class="btn btn-secondary btn-sm reset-player-btn">Reset</button>
                </div>
                <label class="flex items-center space-x-2 text-sm cursor-pointer">
                    <input type="checkbox" name="isAlive" class="form-checkbox bg-gray-700" checked>
                    <span>Naživu</span>
                </label>
            </div>
            <div class="player-equipment space-y-2">
                <select name="armor" class="select-field text-sm">
                    <option value="None">Bez vesty</option>
                    <option value="Kevlar">Kevlar</option>
                    <option value="KevlarHelmet">Kevlar + Helma</option>
                </select>
                <select name="primaryWeapon" class="select-field text-sm">
                    <option value="">Primární zbraň...</option>
                    <optgroup label="Assault Rifles">
                        <option value="AK-47">AK-47</option>
                        <option value="M4A4">M4A4</option>
                        <option value="M4A1-S">M4A1-S</option>
                        <option value="SG 553">SG 553</option>
                        <option value="AUG">AUG</option>
                        <option value="Galil AR">Galil AR</option>
                        <option value="FAMAS">FAMAS</option>
                    </optgroup>
                    <optgroup label="Sniper Rifles">
                        <option value="AWP">AWP</option>
                        <option value="SSG 08">SSG 08</option>
                        <option value="SCAR-20">SCAR-20</option>
                        <option value="G3SG1">G3SG1</option>
                    </optgroup>
                    <optgroup label="Submachine Guns (SMGs)">
                        <option value="UMP-45">UMP-45</option>
                        <option value="MP9">MP9</option>
                        <option value="MAC-10">MAC-10</option>
                        <option value="P90">P90</option>
                        <option value="MP7">MP7</option>
                        <option value="MP5-SD">MP5-SD</option>
                        <option value="PP-Bizon">PP-Bizon</option>
                    </optgroup>
                    <optgroup label="Heavy Weapons">
                        <option value="Nova">Nova</option>
                        <option value="XM1014">XM1014</option>
                        <option value="MAG-7">MAG-7</option>
                        <option value="Sawed-Off">Sawed-Off</option>
                        <option value="M249">M249</option>
                        <option value="Negev">Negev</option>
                    </optgroup>
                </select>
                <select name="pistol" class="select-field text-sm">
                    <option value="">Pistole...</option>
                    <optgroup label="Default">
                        <option value="Glock-18">Glock-18</option>
                        <option value="USP-S">USP-S</option>
                        <option value="P2000">P2000</option>
                    </optgroup>
                    <optgroup label="Purchasable">
                        <option value="Dual Berettas">Dual Berettas</option>
                        <option value="P250">P250</option>
                        <option value="Tec-9">Tec-9</option>
                        <option value="Five-SeveN">Five-SeveN</option>
                        <option value="CZ75-Auto">CZ75-Auto</option>
                        <option value="Desert Eagle">Desert Eagle</option>
                        <option value="R8 Revolver">R8 Revolver</option>
                    </optgroup>
                </select>
                <fieldset class="border border-gray-600 rounded p-2">
                    <legend class="text-xs px-1">Utility</legend>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <label class="flex items-center justify-between">Smoke <input type="number" name="util_smoke"
                                min="0" max="1" value="0" class="input-field !w-16"></label>
                        <label class="flex items-center justify-between">HE <input type="number" name="util_he" min="0"
                                max="1" value="0" class="input-field !w-16"></label>
                        <label class="flex items-center justify-between">Molotov <input type="number"
                                name="util_molotov" min="0" max="1" value="0" class="input-field !w-16"></label>
                        <label class="flex items-center justify-between">Incendiary <input type="number"
                                name="util_incendiary" min="0" max="1" value="0" class="input-field !w-16"></label>
                        <label class="flex items-center justify-between">Decoy <input type="number" name="util_decoy"
                                min="0" max="1" value="0" class="input-field !w-16"></label>
                        <label class="flex items-center justify-between">Flash <input type="number" name="util_flash"
                                min="0" max="2" value="0" class="input-field !w-16"></label>
                    </div>
                </fieldset>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <label class="flex items-center space-x-2"><input type="checkbox" name="hasDefuseKit"
                            class="form-checkbox bg-gray-700"><span>Defuse Kit</span></label>
                    <label class="flex items-center space-x-2"><input type="checkbox" name="hasZeus"
                            class="form-checkbox bg-gray-700"><span>Zeus</span></label>
                </div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Definice
            const APP_STORAGE_KEY = 'cs2DataLoggerState';

            // Elementy
            const demoNameInput = document.getElementById('demoName');
            const roundsContainer = document.getElementById('rounds-container');
            const addRoundBtn = document.getElementById('add-round-btn');
            const generateJsonBtn = document.getElementById('generate-json-btn');
            const copyJsonBtn = document.getElementById('copy-json-btn');
            const jsonOutput = document.getElementById('json-output');
            const messageBox = document.getElementById('message-box');
            const swapTeamsBtn = document.getElementById('swap-teams-btn');
            const playerSetup = document.getElementById('player-setup');
            const ctPlayerNamesContainer = document.getElementById('ct-player-names');
            const tPlayerNamesContainer = document.getElementById('t-player-names');

            // Šablony
            const playerSetupTemplate = document.getElementById('player-setup-template');
            const roundTemplate = document.getElementById('round-template');
            const teamTemplate = document.getElementById('team-template');
            const playerTemplate = document.getElementById('player-template');

            // Ceny a kategorie
            const PRICES = {
                'Kevlar': 650, 'KevlarHelmet': 1000, 'hasZeus': 200, 'hasDefuseKit': 400,
                'util_molotov': 400, 'util_incendiary': 600, 'util_decoy': 50, 'util_flash': 200, 'util_he': 300, 'util_smoke': 300,
                'AK-47': 2700, 'M4A1-S': 2900, 'M4A4': 3100, 'SG 553': 3000, 'Galil AR': 1800, 'FAMAS': 2050, 'AUG': 3300,
                'AWP': 4750, 'SSG 08': 1700, 'SCAR-20': 5000, 'G3SG1': 5000, 'UMP-45': 1200, 'MP9': 1250, 'MAC-10': 1050, 'P90': 2350, 'MP7': 1500, 'MP5-SD': 1500, 'PP-Bizon': 1400,
                'Nova': 1050, 'XM1014': 2000, 'MAG-7': 1300, 'Sawed-Off': 1100, 'M249': 5200, 'Negev': 1700, 'Glock-18': 200, 'USP-S': 200, 'P2000': 200,
                'Dual Berettas': 300, 'P250': 300, 'Tec-9': 500, 'Five-SeveN': 500, 'CZ75-Auto': 500, 'Desert Eagle': 700, 'R8 Revolver': 600
            };
            const WEAPON_CATEGORIES = {
                RIFLES: ['AK-47', 'M4A4', 'M4A1-S', 'SG 553', 'AUG', 'Galil AR', 'FAMAS'], SNIPERS: ['AWP', 'SSG 08', 'SCAR-20', 'G3SG1'], SMGS: ['UMP-45', 'MP9', 'MAC-10', 'P90', 'MP7', 'MP5-SD', 'PP-Bizon'],
                HEAVY: ['Nova', 'XM1014', 'MAG-7', 'Sawed-Off', 'M249', 'Negev'], NON_DEFAULT_PISTOLS: ['Dual Berettas', 'P250', 'Tec-9', 'Five-SeveN', 'CZ75-Auto', 'Desert Eagle', 'R8 Revolver']
            };

            // --- State Management (LocalStorage) ---
            const saveState = () => {
                const state = {
                    demoName: demoNameInput.value,
                    players: {
                        ct: [],
                        t: []
                    },
                    // Note: Round data is saved implicitly by being part of the DOM, which isn't ideal but works for this scope.
                    // A more robust solution would serialize and save round data here as well.
                };
                document.querySelectorAll('#ct-player-names .player-name-input').forEach((input, i) => {
                    const colorInput = document.querySelector(`#ct-player-names .player-color-input[data-index="${i}"]`);
                    state.players.ct.push({ name: input.value, color: colorInput.value });
                });
                document.querySelectorAll('#t-player-names .player-name-input').forEach((input, i) => {
                    const colorInput = document.querySelector(`#t-player-names .player-color-input[data-index="${i}"]`);
                    state.players.t.push({ name: input.value, color: colorInput.value });
                });
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state));
            };

            const loadState = () => {
                const savedState = localStorage.getItem(APP_STORAGE_KEY);
                if (savedState) {
                    const state = JSON.parse(savedState);
                    demoNameInput.value = state.demoName || '';
                    return state.players;
                }
                return null;
            };

            const showMessage = (message, isError = false) => {
                messageBox.textContent = message;
                messageBox.className = `mt-4 text-center font-medium ${isError ? 'text-red-400' : 'text-green-400'}`;
                setTimeout(() => messageBox.textContent = '', 3000);
            };

            const getPlayerConfig = () => {
                const config = { ct: [], t: [] };
                document.querySelectorAll('#ct-player-names .player-name-input').forEach((input, i) => {
                    const colorInput = document.querySelector(`#ct-player-names .player-color-input[data-index="${i}"]`);
                    config.ct.push({ name: input.value, color: colorInput.value });
                });
                document.querySelectorAll('#t-player-names .player-name-input').forEach((input, i) => {
                    const colorInput = document.querySelector(`#t-player-names .player-color-input[data-index="${i}"]`);
                    config.t.push({ name: input.value, color: colorInput.value });
                });
                return config;
            };

            // --- Dynamické výpočty a UI ---
            const updateTeamStats = (teamCard) => {
                // ... (stejná logika jako dříve)
                let stats = { equipmentValue: 0, awpCount: 0, rifleCount: 0, pistolCount: 0, nonDefaultPistolCount: 0, smgCount: 0, defuserCount: 0, utilityTotalCount: 0, smokeCount: 0, molotovCount: 0, incendiaryCount: 0, heGrenadeCount: 0, flashbangCount: 0 };
                teamCard.querySelectorAll('.player-card').forEach(playerCard => {
                    if (!playerCard.querySelector('input[name="isAlive"]').checked) return;
                    const armor = playerCard.querySelector('select[name="armor"]').value;
                    if (PRICES[armor]) stats.equipmentValue += PRICES[armor];
                    const primary = playerCard.querySelector('select[name="primaryWeapon"]').value;
                    if (PRICES[primary]) {
                        stats.equipmentValue += PRICES[primary];
                        if (primary === 'AWP') stats.awpCount++;
                        if (WEAPON_CATEGORIES.RIFLES.includes(primary) || WEAPON_CATEGORIES.SNIPERS.includes(primary)) stats.rifleCount++;
                        if (WEAPON_CATEGORIES.SMGS.includes(primary)) stats.smgCount++;
                    }
                    const pistol = playerCard.querySelector('select[name="pistol"]').value;
                    if (pistol) {
                        stats.pistolCount++;
                        if (PRICES[pistol]) stats.equipmentValue += PRICES[pistol];
                        if (WEAPON_CATEGORIES.NON_DEFAULT_PISTOLS.includes(pistol)) stats.nonDefaultPistolCount++;
                    }
                    playerCard.querySelectorAll('input[type="number"][name^="util_"]').forEach(util => {
                        const count = parseInt(util.value) || 0;
                        if (count > 0) {
                            stats.equipmentValue += (PRICES[util.name] || 0) * count;
                            stats.utilityTotalCount += count;
                            if (util.name === 'util_smoke') stats.smokeCount += count;
                            if (util.name === 'util_molotov') stats.molotovCount += count;
                            if (util.name === 'util_incendiary') stats.incendiaryCount += count;
                            if (util.name === 'util_he') stats.heGrenadeCount += count;
                            if (util.name === 'util_flash') stats.flashbangCount += count;
                        }
                    });
                    if (playerCard.querySelector('input[name="hasDefuseKit"]')?.checked) {
                        stats.equipmentValue += PRICES['hasDefuseKit'] || 0;
                        stats.defuserCount++;
                    }
                    if (playerCard.querySelector('input[name="hasZeus"]').checked) stats.equipmentValue += PRICES['hasZeus'] || 0;
                });
                for (const key in stats) {
                    const input = teamCard.querySelector(`.team-stats input[name="${key}"]`);
                    if (input) input.value = stats[key];
                }
            };

            // --- Vytváření elementů ---
            const addPlayer = (playersContainer, playerConfig, teamType, playerIndex) => {
                const newPlayer = playerTemplate.content.cloneNode(true);
                const playerCard = newPlayer.querySelector('.player-card');
                playerCard.querySelector('.player-name-display').textContent = playerConfig.name;
                playerCard.style.backgroundColor = `${playerConfig.color}40`; // Add alpha for transparency
                playerCard.dataset.playerIndex = playerIndex;
                playerCard.dataset.teamType = teamType.toUpperCase();

                if (teamType !== 'CT') {
                    const defuseKitLabel = newPlayer.querySelector('input[name="hasDefuseKit"]');
                    if (defuseKitLabel) defuseKitLabel.closest('label').remove();
                }

                playersContainer.appendChild(newPlayer);
            };

            const populateTeam = (teamCard, teamType, playersConfig) => {
                const teamContent = teamTemplate.content.cloneNode(true);
                const teamNameDisplay = teamContent.querySelector('.team-name-display');
                teamNameDisplay.textContent = teamType;
                teamNameDisplay.classList.add(teamType === 'CT' ? 'text-cyan-400' : 'text-orange-400');

                const playersContainer = teamContent.querySelector('.players-container');
                playersConfig.forEach((p, i) => {
                    if (p.name) addPlayer(playersContainer, p, teamType, i);
                });

                teamCard.appendChild(teamContent);
                updateTeamStats(teamCard);
            };

            const addRound = () => {
                const roundCount = roundsContainer.children.length;
                const newRoundId = (roundCount > 0 ? Math.max(...Array.from(roundsContainer.querySelectorAll('.round-card')).map(r => parseInt(r.dataset.roundId))) : 0) + 1;

                const newRound = roundTemplate.content.cloneNode(true);
                const roundCard = newRound.querySelector('.round-card');

                roundCard.dataset.roundId = newRoundId;
                roundCard.querySelector('.round-number-display').textContent = newRoundId;
                roundCard.querySelector('input[name="roundNumber"]').value = newRoundId;

                const playersConfig = getPlayerConfig();

                roundCard.querySelectorAll('.snapshot-container').forEach(snapshot => {
                    const ctCard = snapshot.querySelector('.team-card[data-team-type="CT"]');
                    const tCard = snapshot.querySelector('.team-card[data-team-type="T"]');
                    populateTeam(ctCard, 'CT', playersConfig.ct);
                    populateTeam(tCard, 'T', playersConfig.t);
                });

                // --- Kopírování vybavení z minulého kola ---
                if (roundCount > 0) {
                    const lastRound = roundsContainer.children[roundCount - 1];
                    const sourceSnapshot = lastRound.querySelector('[data-snapshot-name="at_20_seconds"]');
                    const targetSnapshot = roundCard.querySelector('[data-snapshot-name="at_1_tick"]');

                    if (sourceSnapshot && targetSnapshot) {
                        sourceSnapshot.querySelectorAll('.player-card').forEach(sourcePlayer => {
                            const playerIndex = sourcePlayer.dataset.playerIndex;
                            const teamType = sourcePlayer.dataset.teamType;
                            const targetPlayer = targetSnapshot.querySelector(`.player-card[data-player-index="${playerIndex}"][data-team-type="${teamType}"]`);

                            if (targetPlayer && sourcePlayer.querySelector('input[name="isAlive"]').checked) {
                                // Klonování hodnot inputů a selectů
                                ['armor', 'primaryWeapon', 'pistol'].forEach(name => {
                                    targetPlayer.querySelector(`select[name="${name}"]`).value = sourcePlayer.querySelector(`select[name="${name}"]`).value;
                                });
                                ['util_smoke', 'util_he', 'util_molotov', 'util_incendiary', 'util_decoy', 'util_flash'].forEach(name => {
                                    targetPlayer.querySelector(`input[name="${name}"]`).value = sourcePlayer.querySelector(`input[name="${name}"]`).value;
                                });
                                ['hasDefuseKit', 'hasZeus'].forEach(name => {
                                    const sourceCheckbox = sourcePlayer.querySelector(`input[name="${name}"]`);
                                    const targetCheckbox = targetPlayer.querySelector(`input[name="${name}"]`);
                                    if (sourceCheckbox && targetCheckbox) {
                                        targetCheckbox.checked = sourceCheckbox.checked;
                                    }
                                });
                            }
                        });
                        // Přepočítání statistik po zkopírování
                        targetSnapshot.querySelectorAll('.team-card').forEach(updateTeamStats);
                    }
                }

                roundsContainer.appendChild(newRound);
            };

            // --- Event Listeners ---
            playerSetup.addEventListener('input', (e) => {
                if (!e.target.classList.contains('player-name-input') && !e.target.classList.contains('player-color-input')) return;

                const playerIndex = e.target.dataset.index;
                const team = e.target.closest('[data-team]').dataset.team.toUpperCase();
                const config = getPlayerConfig();
                const playerConfig = team === 'CT' ? config.ct[playerIndex] : config.t[playerIndex];

                document.querySelectorAll(`.player-card[data-team-type="${team}"][data-player-index="${playerIndex}"]`).forEach(playerCard => {
                    if (e.target.classList.contains('player-name-input')) {
                        playerCard.querySelector('.player-name-display').textContent = playerConfig.name;
                    }
                    if (e.target.classList.contains('player-color-input')) {
                        playerCard.style.backgroundColor = `${playerConfig.color}40`;
                    }
                });
                saveState();
            });

            demoNameInput.addEventListener('input', saveState);

            swapTeamsBtn.addEventListener('click', () => {
                const config = getPlayerConfig();
                const ctConf = JSON.parse(JSON.stringify(config.ct));
                const tConf = JSON.parse(JSON.stringify(config.t));

                populatePlayerSetup(tConf, ctConf);

                document.querySelectorAll('.round-card').forEach(round => round.remove());
                // Zde by se mohla přidat logika pro "chytrou" výměnu hráčů i v existujících kolech,
                // ale pro jednoduchost je smažeme a uživatel si je přidá znovu s prohozenými týmy.
                showMessage('Týmy prohozeny. Existující kola byla odstraněna.', false);
                saveState();
            });

            roundsContainer.addEventListener('click', (e) => {
                // Reset hráče
                if (e.target.classList.contains('reset-player-btn')) {
                    const playerCard = e.target.closest('.player-card');
                    playerCard.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                    playerCard.querySelectorAll('input[type="number"]').forEach(i => i.value = '0');
                    playerCard.querySelectorAll('input[type="checkbox"]').forEach(c => c.name !== 'isAlive' ? c.checked = false : null);
                    updateTeamStats(playerCard.closest('.team-card'));
                }
                // Smazání kola
                if (e.target.classList.contains('remove-round-btn')) {
                    e.target.closest('.round-card').remove();
                }
            });

            roundsContainer.addEventListener('change', (e) => {
                if (e.target.closest('.player-equipment')) {
                    updateTeamStats(e.target.closest('.team-card'));
                }
            });
            roundsContainer.addEventListener('input', (e) => {
                if (e.target.closest('.player-equipment') && e.target.type === 'number') {
                    updateTeamStats(e.target.closest('.team-card'));
                }
            });

            addRoundBtn.addEventListener('click', addRound);
            generateJsonBtn.addEventListener('click', () => { /* ... stejná logika ... */ });
            copyJsonBtn.addEventListener('click', () => { /* ... stejná logika ... */ });

            // --- Inicializace ---
            function populatePlayerSetup(ctPlayers, tPlayers) {
                ctPlayerNamesContainer.innerHTML = '';
                tPlayerNamesContainer.innerHTML = '';
                ctPlayers.forEach((p, i) => {
                    const node = playerSetupTemplate.content.cloneNode(true);
                    node.querySelector('.player-name-input').value = p.name;
                    node.querySelector('.player-name-input').dataset.index = i;
                    node.querySelector('.player-color-input').value = p.color;
                    node.querySelector('.player-color-input').dataset.index = i;
                    ctPlayerNamesContainer.appendChild(node);
                });
                tPlayers.forEach((p, i) => {
                    const node = playerSetupTemplate.content.cloneNode(true);
                    node.querySelector('.player-name-input').value = p.name;
                    node.querySelector('.player-name-input').dataset.index = i;
                    node.querySelector('.player-color-input').value = p.color;
                    node.querySelector('.player-color-input').dataset.index = i;
                    tPlayerNamesContainer.appendChild(node);
                });
            }

            function initialize() {
                let players = loadState();
                if (!players) {
                    players = {
                        ct: [{ name: 'Hráč A', color: '#63b3ed' }, { name: 'Hráč B', color: '#4fd1c5' }, { name: 'Hráč C', color: '#9f7aea' }, { name: 'Hráč D', color: '#faf089' }, { name: 'Hráč E', color: '#f6ad55' }],
                        t: [{ name: 'Hráč F', color: '#f56565' }, { name: 'Hráč G', color: '#ed8936' }, { name: 'Hráč H', color: '#d69e2e' }, { name: 'Hráč I', color: '#f6e05e' }, { name: 'Hráč J', color: '#a0aec0' }]
                    };
                }
                populatePlayerSetup(players.ct, players.t);
                // Note: We don't load rounds from localStorage in this version to keep it simple.
                // User starts with a clean slate of rounds each time, but player names/colors are saved.
            }

            initialize();
        });
    </script>

</body>

</html>
